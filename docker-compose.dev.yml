# docker-compose.dev.yml
# Configuración para DESARROLLO (rama develop)
# Uso: docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d

services:
  php:
    environment:
      APP_ENV: local
      APP_DEBUG: "true"
      PHP_OPCACHE_ENABLE: 0
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: 1
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  node:
    image: node:20-alpine
    working_dir: /var/www/html
    volumes:
      - .:/var/www/html
    command: sh -c "cd Laravel_app && npm install && npm run dev"
    ports:
      - "5173:5173"
    networks:
      - network_app
    profiles:
      - dev

  vue:
    image: node:20-alpine
    user: "1000:1000"
    working_dir: /app
    volumes:
      - ./Vue_app:/app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5174"
    ports:
      - "5174:5174"
    networks:
      - network_app
    profiles:
      - dev

  nginx:
    ports:
      - "8090:80"
      - "8081:8081"
    depends_on:
      - php
      - node
      - vue
    environment:
      NGINX_ENVSUBST_OUTPUT_DIR: /etc/nginx/conf.d

  db:
    ports:
      - "5432:5432"  # Expuesto para herramientas externas (pgAdmin, DBeaver)
    environment:
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=es_ES.UTF-8 --lc-ctype=es_ES.UTF-8"

  redis:
    ports:
      - "6379:6379"  # Expuesto para Redis Commander

  mailpit:
    image: 'axllent/mailpit:latest'
    ports:
      - "8025:8025"  # Web UI
      - "1025:1025"  # SMTP
    networks:
      - network_app
    profiles:
      - dev

# Sin límites estrictos en desarrollo
networks:
  network_app:
    driver: bridge
