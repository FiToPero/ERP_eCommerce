# docker-compose.prod.yml
# Configuración para PRODUCCIÓN (rama main)
# Uso: docker compose -f docker-compose.base.yml -f docker-compose.prod.yml up -d

services:
  php:
    restart: unless-stopped
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      PHP_OPCACHE_ENABLE: 1
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: 0
      PHP_OPCACHE_REVALIDATE_FREQ: 0
      PHP_OPCACHE_MAX_ACCELERATED_FILES: 20000
      PHP_OPCACHE_MEMORY_CONSUMPTION: 256
    deploy:
      replicas: 2  # Load balancing con 2 instancias PHP
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 60s
      resources:
        limits:
          cpus: "1.5"
          memory: 1024M
        reservations:
          cpus: "0.5"
          memory: 512M
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD", "php-fpm-healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # NO incluir servicios node/vue en producción
  # Los assets ya están compilados con npm run build

  nginx:
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - .:/var/www/html:ro  # Read-only para seguridad
      - ./docker/nginx/default.prod.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro  # Certificados SSL
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  db:
    restart: unless-stopped
    # NO exponer puerto 5432 en producción (solo acceso interno)
    environment:
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
      resources:
        limits:
          cpus: "2"
          memory: 2048M
        reservations:
          cpus: "1"
          memory: 1024M
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    restart: unless-stopped
    # NO exponer puerto 6379 en producción
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Mailpit NO se incluye en producción (usar SMTP real)
  # Configurar MAIL_MAILER=smtp con credenciales reales en .env

# En producción, usar overlay network para Swarm (opcional)
networks:
  network_app:
    driver: bridge  # Cambiar a 'overlay' si usas Docker Swarm
